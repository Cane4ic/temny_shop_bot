<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TEMNY SHOP ‚Äî WebApp</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#000;--panel:#0b0b0b;--glow:0 8px 30px rgba(255,255,255,0.06),0 2px 6px rgba(0,0,0,0.6);--accent:linear-gradient(90deg,#ff7aa7,#ffb0d6);--text:#fff;--muted:rgba(255,255,255,0.55);--btn-inner:rgba(255,255,255,0.03);}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;display:flex;align-items:center;justify-content:center;padding:12px;}
  .app{width:100%;max-width:420px;height:100vh;display:flex;flex-direction:column;gap:14px;align-items:stretch;}
  .header{text-align:center;margin-top:6vh;}
  .title{font-family:"Cinzel Decorative",serif;font-size:38px;letter-spacing:2px;color:#fff;text-shadow:0 2px 0 rgba(255,255,255,0.06),0 10px 30px rgba(0,0,0,0.7);margin:0;}
  .subtitle{margin-top:10px;font-size:16px;line-height:1.25;color:var(--muted);font-weight:300;text-transform:uppercase;letter-spacing:2px;}
  .menu{padding:18px 12px;display:flex;flex-direction:column;gap:12px;align-items:stretch;flex:0 0 auto;}
  .big-btn{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.35));border-radius:18px;padding:14px 14px;display:flex;align-items:center;gap:14px;box-shadow:0 0 0 3px rgba(255,255,255,0.03),0 18px 40px rgba(0,0,0,0.7),0 6px 20px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:transform .14s ease,box-shadow .14s ease;position:relative;overflow:hidden;}
  .big-btn:before{content:"";position:absolute;inset:-6px;border-radius:22px;box-shadow:0 0 30px rgba(255,255,255,0.06);pointer-events:none;opacity:0.9;mix-blend-mode:screen;}
  .big-btn:hover{transform:translateY(-4px);box-shadow:0 28px 60px rgba(0,0,0,0.8);}
  .icon-wrap{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#0f0f10,#19191c);display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);}
  .btn-label{flex:1;font-weight:700;font-size:20px;letter-spacing:1px;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,0.6);}
  .chev{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.6);font-size:18px;}
  .view{flex:1 1 auto;overflow:hidden;display:flex;flex-direction:column;}
  .list-wrap{flex:1 1 auto;overflow:auto;padding:0 12px 24px;}
  .backbar{display:flex;align-items:center;gap:12px;padding:12px 6px;}
  .backbtn{width:42px;height:42px;border-radius:10px;background:rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);cursor:pointer;}
  .page-title{font-size:18px;font-weight:700}
  .products{display:flex;flex-direction:column;gap:12px;margin-top:8px}
  .product{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.4));border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(0,0,0,0.6);}
  .product .picon{width:56px;height:56px;border-radius:10px;background:#090909;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px}
  .product .pmeta{flex:1}
  .pmeta .name{font-size:16px;font-weight:700}
  .pmeta .desc{font-size:12px;color:var(--muted);margin-top:6px}
  .pmeta .price{font-size:14px;font-weight:700;color:#fff;margin-top:6px}
  .spacer{height:8vh;flex:0 0 auto}
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:999;display:none;opacity:0;transition:opacity 0.2s;}
  .modal.show{display:flex;opacity:1;}
  .modal-content{background:#0b0b0b;padding:20px;border-radius:14px;width:90%;max-width:300px;text-align:center;}
  .modal-content input{width:100%;padding:10px;border-radius:10px;border:1px solid #222;background:#000;color:#fff;margin-bottom:12px;font-size:16px;}
  .modal-content button{padding:10px 20px;border-radius:10px;border:0;background:var(--accent);color:#000;font-weight:700;cursor:pointer;font-size:16px;}
  @media (max-width:380px){.title{font-size:34px}.big-btn{padding:12px}.icon-wrap{width:48px;height:48px}.btn-label{font-size:18px}}

  /* –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ñ—É—Ç–µ—Ä */
  .footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    max-width: 420px;
    background: transparent;
    display: flex;
    justify-content: center;
    padding: 6px 0;
    z-index: 10;
  }
  .footer-btn {
    font-size: 28px;
    cursor: pointer;
    padding: 8px;
    border-radius: 10px;
    transition: background 0.2s;
  }
  .footer-btn:hover { background: rgba(255,255,255,0.05); }

  /* –°—Ç–∏–ª—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ñ–∏–ª—è */
  .profile-page{padding: 24px;display:flex;flex-direction:column;gap:16px;align-items:center;}
  .profile-item{font-size:16px;font-weight:500;color:#fff;}
  .profile-balance{font-size:20px;font-weight:700;color:#ffb0d6;}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="view" data-view="menu">
    <div class="header">
      <h1 class="title">TEMNY SHOP</h1>
      <div class="subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤<br>–õ—É—á—à–∏–π –º–∞–≥–∞–∑–∏–Ω –∞–∫–∫–∞—É–Ω—Ç–æ–≤<br>–¥–ª—è –∞—Ä–±–∏—Ç—Ä–∞–∂–∞ —Ç—Ä–∞—Ñ–∏–∫–∞</div>
    </div>
    <div class="menu" id="menuCategories" role="navigation" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏"></div>
    <div class="spacer"></div>
  </div>

  <div class="view" data-view="products" style="display:none">
    <div class="backbar">
      <div class="backbtn" onclick="goBack()" aria-label="–ù–∞–∑–∞–¥">‚Üê</div>
      <div class="page-title" id="catTitle">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
    </div>
    <div class="list-wrap">
      <div class="products" id="productsList"></div>
    </div>
    <div style="height:6vh"></div>
  </div>

  <div class="view" data-view="profile" style="display:none">
    <div class="backbar">
      <div class="backbtn" onclick="goBack()" aria-label="–ù–∞–∑–∞–¥">‚Üê</div>
      <div class="page-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
    <div class="profile-page">
      <div class="profile-item">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="profileId">0</span></div>
      <div class="profile-item">–ë–∞–ª–∞–Ω—Å: $<span id="profileBalance">0</span></div>
      <div class="big-btn" onclick="showDepositModal()">
        <div class="icon-wrap">üí∞</div>
        <div class="btn-label">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="depositModal">
  <div class="modal-content">
    <h3>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
    <input type="number" id="depositAmount" placeholder="–°—É–º–º–∞ –≤ $" min="1">
    <button onclick="submitDeposit()">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
  </div>
</div>

<div class="footer">
  <div class="footer-btn" onclick="openProfile()">üë§</div>
</div>

<script>
let CATALOG = {};
let USER_BALANCE = 0;
let USER_ID = 0;

async function getUserId(){
  if(!window.Telegram || !window.Telegram.WebApp) return 0;
  try {
    window.Telegram.WebApp.ready();
    return Number(window.Telegram.WebApp.initData?.user?.id || window.Telegram.WebApp.initDataUnsafe?.user?.id || 0);
  } catch(e){
    console.warn("Telegram WebApp –Ω–µ –≥–æ—Ç–æ–≤:", e);
    return 0;
  }
}

async function loadBalance(){
  if(!USER_ID) return;
  try {
    const res = await fetch(`/get_balance?user_id=${USER_ID}&_=${Date.now()}`, { cache: "no-store" });
    const data = await res.json();
    if(data.balance !== undefined){
      const newBalance = parseFloat(data.balance) || 0;
      if(newBalance !== USER_BALANCE){
        USER_BALANCE = newBalance;
        document.getElementById('profileBalance').textContent = USER_BALANCE.toFixed(2);
        updateBuyButtons();
      }
    }
  } catch(e){ console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:", e); }
}

async function loadCatalog() {
  try {
    const res = await fetch("/products");
    const data = await res.json();
    CATALOG = {};
    data.forEach(info => {
      const cat = info.category || "Other";
      if(!CATALOG[cat]) CATALOG[cat] = { title: cat.toUpperCase(), items: [] };
      CATALOG[cat].items.push({
        id: info.name,
        name: info.name,
        desc: `–û—Å—Ç–∞—Ç–æ–∫: ${info.stock}`,
        price: parseFloat(info.price) || 0,
        stock: info.stock
      });
    });
  } catch (err) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:", err); }
}

function renderCategories(){
  const menu = document.getElementById('menuCategories');
  menu.innerHTML = '';
  for(const [key, cat] of Object.entries(CATALOG)){
    const div = document.createElement('div');
    div.className = 'big-btn';
    div.dataset.target = key;
    div.innerHTML = `<div class="icon-wrap">‚ú¶</div><div class="btn-label">${cat.title}</div><div class="chev">ÀÖ</div>`;
    div.onclick = ()=>openCategory(key);
    menu.appendChild(div);
  }
}

function openCategory(key){
  const cat = CATALOG[key];
  if(!cat) return;
  document.getElementById('catTitle').textContent = cat.title;
  const cont = document.getElementById('productsList');
  cont.innerHTML = '';
  cat.items.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'product';
    const disabled = USER_BALANCE < p.price || p.stock <= 0 ? 'disabled' : '';
    el.innerHTML = `
      <div class="picon">${(p.name||'').charAt(0)}</div>
      <div class="pmeta">
        <div class="name">${p.name}</div>
        <div class="desc">${p.desc}</div>
        <div class="price">$${p.price.toFixed(2)}</div>
      </div>
      <div style="display:flex;align-items:center">
        <button ${disabled} style="padding:8px 12px;border-radius:10px;border:0;background:var(--btn-inner);color:var(--text);cursor:pointer" onclick="buy('${p.id}','${key}')">–ö—É–ø–∏—Ç—å</button>
      </div>
    `;
    cont.appendChild(el);
  });
  showView('products');
  document.querySelector('.list-wrap').scrollTop = 0;
}

function updateBuyButtons(){
  document.querySelectorAll('.products .product').forEach((el)=>{
    const price = parseFloat(el.querySelector('.price').textContent.replace('$',''))||0;
    const stockText = el.querySelector('.desc').textContent.match(/\d+/);
    const stock = stockText ? parseInt(stockText[0]) : 0;
    const btn = el.querySelector('button');
    btn.disabled = USER_BALANCE < price || stock <= 0;
  });
}

function goBack(){ showView('menu'); }

async function buy(id, cat){
  const catObj = CATALOG[cat];
  const item = (catObj.items || []).find(x=>x.id===id);
  if(!item) return alert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
  if(item.price > USER_BALANCE) return alert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ');

  document.body.style.cursor = 'wait';
  try {
    const res = await fetch('/buy_product', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ product_name: item.name, price: item.price, telegram_user_id: USER_ID })
    });
    const data = await res.json();
    if(data.status === 'ok'){
      await loadBalance();
      alert(`‚úÖ –¢–æ–≤–∞—Ä "${item.name}" —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!`);
      await loadCatalog();
      renderCategories();
    } else { alert(`‚ùå ${data.error}`); }
  } catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ'); }
  finally{ document.body.style.cursor = 'default'; }
}

function showDepositModal(){ document.getElementById('depositModal').classList.add('show'); }
function hideDepositModal(){ document.getElementById('depositModal').classList.remove('show'); }

async function submitDeposit(){
  const amount = parseFloat(document.getElementById('depositAmount').value);
  if(isNaN(amount) || amount <= 0) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
  if(!USER_ID) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

  hideDepositModal();
  document.body.style.cursor = 'wait';
  try{
    const res = await fetch('/create_deposit', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({telegram_user_id:USER_ID, amount:amount})
    });
    const data = await res.json();
    if(data.status==='ok'){
      await loadBalance();
      alert(`üí∞ –ü–ª–∞—Ç—ë–∂ –Ω–∞ $${amount} —Å–æ–∑–¥–∞–Ω. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`);
    } else { alert(`–û—à–∏–±–∫–∞: ${data.error}`); }
  }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞'); }
  finally{ document.body.style.cursor = 'default'; }
}

function showView(name){
  document.querySelectorAll('.view').forEach(v=>{ v.style.display = (v.getAttribute('data-view')===name)?'flex':'none'; });
}

function openProfile(){
  document.getElementById('profileId').textContent = USER_ID;
  document.getElementById('profileBalance').textContent = USER_BALANCE.toFixed(2);
  showView('profile');
}

async function initWebApp(){
  USER_ID = await getUserId();
  await loadCatalog();
  renderCategories();
  await loadBalance();
  showView('menu');
  setInterval(loadBalance, 2000);
}

initWebApp();

try{
  if(window.Telegram && window.Telegram.WebApp){
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand?.();
  }
}catch(e){}
</script>
</body>
</html>
